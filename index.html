<!DOCTYPE html>
<html>

<head>
</head>

<body>
    <canvas width="400" height="400" id="game" style="background-color: black;"></canvas>
</body>
<script src="https://cdn.jsdelivr.net/npm/kontra@7.1.3/kontra.min.js"></script>
<script>
    // Import all thats needed
    let { GameLoop, Sprite, bindKeys, collides, init, initKeys, keyPressed, randInt, TileEngine } = kontra;
    // Init canvas
    let { canvas } = init();
    // Define our character sprite (to replace with proper art)
    let sprite = Sprite({
        x: 0,        // starting x,y position of the sprite
        y: 0,
        anchor: {x: 0, y: 0},
        color: 'red',  // fill color of the sprite rectangle
        width: 16,     // width and height of the sprite rectangle
        height: 16,
        dx: 8,          // move the sprite 2px to the right every frame
        dy: 8          // move the sprite 2px to the right every frame
    });
    // Create a new image
    let img = new Image();
    img.src = 'assets/tilesheet.png';
    // On image load
    img.onload = () => {
        // Initialize Tile Engine based on the tilwsheet
        let tileEngine = TileEngine({
            // tile size
            tilewidth: 16,
            tileheight: 16,
            // map size in tiles
            width: 6,
            height: 5,
            // tileset object
            tilesets: [{
                firstgid: 1,
                image: img
            }],
            // layer object
            layers: [{
                name: 'ground',
                data: [
                    1, 1, 1, 1, 1, 1,
                    1, 1, 1, 1, 1, 1,
                    1, 1, 2, 2, 1, 1,
                    1, 1, 2, 2, 1, 1,
                    1, 1, 1, 1, 1, 1,
                ]
            },{
                name: 'collision',
                data: [
                    0, 0, 0, 0, 0, 0,
                    0, 0, 0, 0, 0, 0,
                    0, 0, 1, 1, 0, 0,
                    0, 0, 1, 1, 0, 0,
                    0, 0, 0, 0, 0, 0,
                ]
            }]
        });
        // Add sprite to the tile engine this helps with collisions and more
        tileEngine.addObject(sprite);


        let loop = GameLoop({  // create the main game loop
            update: function () { // update the game state
                // handle moving around
                if (keyPressed('left')) {
                    // When going left we need to check the top left corner and the bottom left corner are not entering collision
                    if(tileEngine.tileAtLayer("collision", {x: sprite.x - 1, y: sprite.y + 1}) === 1 ||
                    tileEngine.tileAtLayer("collision", {x: sprite.x - 1, y: sprite.y + sprite.height - 1}) === 1) {
                        sprite.x = sprite.x
                    } else {
                        sprite.x = sprite.x - 1;
                    }
                }
                if (keyPressed('right')) {
                    if(tileEngine.tileAtLayer("collision", {x: sprite.x + 1 + sprite.width, y: sprite.y + 1}) === 1 ||
                    tileEngine.tileAtLayer("collision", {x: sprite.x + 1 + sprite.width, y: sprite.y + sprite.height - 1}) === 1) {
                        sprite.x = sprite.x
                    } else {
                        sprite.x = sprite.x + 1;
                    }
                }
                if (keyPressed('up')) {
                    if(tileEngine.tileAtLayer("collision", {x: sprite.x, y: sprite.y - 1}) === 1 ||
                    tileEngine.tileAtLayer("collision", {x: sprite.x + sprite.width, y: sprite.y - 1}) === 1) {
                        sprite.y = sprite.y
                    } else {
                        sprite.y = sprite.y - 1;
                    }
                }
                if (keyPressed('down')) {
                    if(tileEngine.tileAtLayer("collision", {x: sprite.x, y: sprite.y + sprite.height + 1}) === 1 ||
                    tileEngine.tileAtLayer("collision", {x: sprite.x + sprite.width, y: sprite.y + sprite.height + 1}) === 1) {
                        sprite.y = sprite.y
                    } else {
                        sprite.y = sprite.y + 1;
                    }
                }

            },
            render: () => { // render the game state
                // Non need to render the collision layer
                tileEngine.renderLayer("ground");
                sprite.render();
            }
        });

        // Load key binding
        initKeys();
        // start the game
        loop.start();    
    }
</script>
</html>